from glob import glob
configfile: "config_ont.yaml"
configfile: "config_hifi.yaml"
print(config)

cell_lines = list(set(list(map(lambda x: os.path.basename(x).split('.')[0], glob("normal_v2/msv/*msv")))))

cell_lines_sub = [cell for cell in list(set(list(map(lambda x: os.path.basename(x).split('.')[0], glob("normal_v2/msv/*msv"))))) if 'BL' not in cell]
print(cell_lines)
print(cell_lines_sub)

cell_lines_labels = list(set(list(map(lambda x: os.path.basename(x).split('.')[0], glob("normal_v2/msv/*msv")))))
cell_lines_labels1 = [ l.replace('BL', '') for l in cell_lines_labels if 'BL' in l ]
cell_lines_labels2 = [ l for l in cell_lines_labels if 'BL' not in l ]
print(cell_lines_labels)
print(cell_lines_labels1)
print(cell_lines_labels2)

wildcard_constraints:
    cell_line = "[A-Za-z0-9]+",
    cell_line_label1 = "[A-Za-z0-9]+",
    cell_line_label2 = "[A-Za-z0-9]+",
    pair = "BL|T",
    assembly = "chm13|grch38|hg38",
    platform = "ont1|ont2|hifi1"


include: "rules/minisv_eval_all_tools_from1a.smk"
minisv_eval_tnpair_files_hifi = expand(expand("output/minisv_eval_tnpair_from1a/{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval.tsv", zip, cell_line=config['hifi_samples']['tumor_normal_pair']['batch1']['cell_line1'], platform=config['hifi_samples']['tumor_normal_pair']['batch1']['platform1']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10])
minisv_eval_tnpair_concensus_files_hifi = expand(expand("output/minisv_eval_tnpair_concensus_from1a/{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval.tsv", zip, cell_line=config['hifi_samples']['tumor_normal_pair']['batch1']['cell_line1'], platform=config['hifi_samples']['tumor_normal_pair']['batch1']['platform1']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10])
minisv_eval_tnpair_concensus_files_ont = expand(expand("output/minisv_eval_tnpair_concensus_from1a/{{folder}}_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_tg.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch3']['cell_line3'], platform=config['samples']['tumor_normal_pair']['batch3']['platform3']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch3']['label']) + expand(expand("output/minisv_eval_tnpair_concensus_from1a/{{folder}}_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_tg.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch4']['cell_line4'], platform=config['samples']['tumor_normal_pair']['batch4']['platform4']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch4']['label'])
minisv_eval_tnpair_concensus_files_ont_tgs = expand(expand("output/minisv_eval_tnpair_concensus_from1a/{{folder}}_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_tgs.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch3']['cell_line3'], platform=config['samples']['tumor_normal_pair']['batch3']['platform3']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch3']['label']) + expand(expand("output/minisv_eval_tnpair_concensus_from1a/{{folder}}_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_tgs.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch4']['cell_line4'], platform=config['samples']['tumor_normal_pair']['batch4']['platform4']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch4']['label'])

minisv_eval_singlemode_files_hifi = expand(expand("output/minisv_eval_singleT/single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval.tsv", zip, cell_line=config['hifi_samples']['tumor_normal_pair']['batch1']['cell_line1'], platform=config['hifi_samples']['tumor_normal_pair']['batch1']['platform1']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10])
minisv_eval_singlemode_files_hifi_100kb = expand(expand("output/minisv_eval_singleT/single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_100kb.tsv", zip, cell_line=config['hifi_samples']['tumor_normal_pair']['batch1']['cell_line1'], platform=config['hifi_samples']['tumor_normal_pair']['batch1']['platform1']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10])

# output/minisv_eval_singleT/{{folder}}_single_{{cell_line}}_{{platform}}_{{assembly}}_count{cutoff}_eval_ont_100kb.tsv
minisv_eval_singlemode_files_ont_100kb = expand(expand("output/minisv_eval_singleT/{{folder}}_single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_ont_100kb.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch3']['cell_line3'], platform=config['samples']['tumor_normal_pair']['batch3']['platform3']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch3']['label']) + expand(expand("output/minisv_eval_singleT/{{folder}}_single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_ont_100kb.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch4']['cell_line4'], platform=config['samples']['tumor_normal_pair']['batch4']['platform4']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch4']['label'])



def cat_minisv_view(input_files, output):
    import pandas as pd
    df_list = []
    for file in input_files:
        df = pd.read_table(file, header=None)
        df['count'] = os.path.basename(file).split('_')[-1].replace('.tsv', '').replace('count', '')
        df['count_file'] = file
        #df.columns[:7] = ['translocation', '>1M', '>100k', '>20k', 'all_except_inv', 'inv', 'file']
        df_list.append(df)
    
    # Concatenate all DataFrames
    combined_df = pd.concat(df_list, axis=0, ignore_index=True)
    
    # Save the concatenated DataFrame to a new CSV file
    combined_df.to_csv(output, index=False, sep='\t', header=False)


rule phased_minisv_hg38_tg:
    input:
         msv = "normal_v2/msv/{cell_line}.hg38l+tg.c2s0.msv",
         hptag = "../1b.alignment_sv_tools_normal/output/extract_hp/{cell_line}_grch38.tsv.gz"
    output:
         "output/minisv_phase/{cell_line}_grch38_phased_tg.msv"
    conda: "minisvpy"
    shell:
         """
         zcat {input.hptag} | minisv annotatehp - {input.msv}  > {output}
         """

rule phased_minisv_hg38_tg_filter:
    input:
         msv = rules.phased_minisv_hg38_tg.output
    output:
         "output/minisv_phase/{cell_line}_grch38_phased_tg_filtered.msv"
    conda: "minisvpy"
    shell:
         """
         awk 'BEGIN{{IFS="\\t"}} {{split($NF, a, ","); if (!(a[2]>=1 && a[3]>=1)) {{print $0}}}}' {input} > {output}
         """


rule gafcall_eval_length:
    input:
        minisv = expand("normal_v2/msv/{{cell_line}}.{{comb}}.{count}.msv", count=['c2s0'])
    output:
        eval_length = "output/gafcall_eval/normal_v2/{cell_line}_{comb}_eval_len_count{cnt}.tsv"
    shell:
        """
        for input in {input.minisv}; do
            if [[ $input =~ "chm13" ]]; then
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/chm13.reg.bed -c {wildcards.cnt} -C -I $input >> {output.eval_length} 
            else
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/hg38.reg.bed -c {wildcards.cnt} -C -I $input >> {output.eval_length} 
            fi
        done
        """


rule gafcall_eval_length_severus_BL:
    input:
        severus = "../1a.alignment_sv_tools/output/severus_hifi1/{cell_line_label1}_BL_{assembly}/all_SVs/severus_all.vcf"
    output:
        severus = "output/gafcall_eval/normal_v2_{assembly}_severus1/{cell_line_label1}_eval_len_count{cnt}.tsv"
    shell:
        """
        for input in {input.severus}; do
            if [[ $input =~ "chm13" ]]; then
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/chm13.reg.bed -c {wildcards.cnt} -C -I $input >> {output.severus} 
            else
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/hg38.reg.bed -c {wildcards.cnt} -C -I $input >> {output.severus} 
            fi
        done
        """


rule gafcall_eval_length_severus_normal:
    input:
        severus = "../1b.alignment_sv_tools_normal/output/severus/{cell_line_label2}/{assembly}/all_SVs/severus_all.vcf"
    output:
        severus = "output/gafcall_eval/normal_v2_{assembly}_severus2/{cell_line_label2}_eval_len_count{cnt}.tsv"
    shell:
        """
        for input in {input.severus}; do
            if [[ $input =~ "chm13" ]]; then
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/chm13.reg.bed -c {wildcards.cnt} -C -I $input >> {output.severus} 
            else
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/hg38.reg.bed -c {wildcards.cnt} -C -I $input >> {output.severus} 
            fi
        done
        """

rule gafcall_eval_length_combine_severus:
    input:
        severus = expand("output/gafcall_eval/normal_v2_{assembly}_severus1/{{cell_line_label1}}_eval_len_count{cnt}.tsv", assembly=['chm13', 'grch38'], cnt=[2, 3, 4, 5])
    output:
        severus = "output/gafcall_eval/normal_v2_severus1/{cell_line_label1}_merged_eval.len.tsv"
    run:
        #"""cat {input.severus} > {output.severus}"""

        cat_minisv_view(input.severus, output.severus)



rule gafcall_eval_length_combine_severus2:
    input:
        severus = expand("output/gafcall_eval/normal_v2_{assembly}_severus2/{{cell_line_label2}}_eval_len_count{cnt}.tsv", assembly=['chm13', 'grch38'], cnt=[2, 3, 4, 5])
    output:
        severus = "output/gafcall_eval/normal_v2_severus2/{cell_line_label2}_merged_eval.len.tsv"
    run:
        #"""cat {input.severus} > {output.severus}"""

        cat_minisv_view(input.severus, output.severus)


rule gafcall_eval_length_merge_all_severus:
    input:
        eval_length1 = expand("output/gafcall_eval/normal_v2_severus1/{cell_line_label1}_merged_eval.len.tsv", cell_line_label1=cell_lines_labels1),
        eval_length2 = expand("output/gafcall_eval/normal_v2_severus2/{cell_line_label2}_merged_eval.len.tsv", cell_line_label2=cell_lines_labels2)
    output:
        eval_length = "output/gafcall_eval/normal_v2/severus_all_merged_eval.len.tsv"
    shell:
        #"echo -e 'translocation\t>1M\t>100k\t>20k\tall_except_inv\tinv\tfile' > {output.eval_length} && cat {input.eval_length1} {input.eval_length2} >> {output.eval_length}"
        "cat {input.eval_length1} {input.eval_length2} >> {output.eval_length}"



rule gafcall_eval_length_cutesv_normal:
    input:
        cutesv = "../1b.alignment_sv_tools_normal/output/cutesv/{cell_line_label2}/{assembly}.vcf.gz"
    output:
        cutesv = "output/gafcall_eval/normal_v2_{assembly}_cutesv2/{cell_line_label2}_eval_len_count{cnt}.tsv"
    shell:
        """
        for input in {input.cutesv}; do
            if [[ $input =~ "chm13" ]]; then
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/chm13.reg.bed -c {wildcards.cnt} -C -I $input >> {output.cutesv} 
            else
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/hg38.reg.bed -c {wildcards.cnt} -C -I $input >> {output.cutesv} 
            fi
        done
        """

rule gafcall_eval_length_combine_cutesv2:
    input:
        cutesv = expand("output/gafcall_eval/normal_v2_{assembly}_cutesv2/{{cell_line_label2}}_eval_len_count{cnt}.tsv", assembly=['chm13', 'grch38'], cnt=[2, 3, 4, 5])
    output:
        cutesv = "output/gafcall_eval/normal_v2_cutesv2/{cell_line_label2}_merged_eval.len.tsv"
    run:
        cat_minisv_view(input.cutesv, output.cutesv)


rule gafcall_eval_length_merge_all_cutesv:
    input:
        eval_length2 = expand("output/gafcall_eval/normal_v2_cutesv2/{cell_line_label2}_merged_eval.len.tsv", cell_line_label2=cell_lines_labels2)
    output:
        eval_length = "output/gafcall_eval/normal_v2/cutesv_all_merged_eval.len.tsv"
    shell:
        "cat {input.eval_length2} >> {output.eval_length}"


rule gafcall_eval_length_snf_BL:
    input:
        #../1a.alignment_sv_tools/output/sniffles_mosaic/COLO829_hifi1/BL/chm13.vcf.gz
        snf = "../1a.alignment_sv_tools/output/sniffles_mosaic/{cell_line_label1}_hifi1/BL/{assembly}.vcf.gz",
        snf_germline = "../1a.alignment_sv_tools/output/sniffles/{cell_line_label1}_hifi1/BL/{assembly}.vcf.gz"
    output:
        snf = "output/gafcall_eval/normal_v2_{assembly}_snf1/{cell_line_label1}_eval_len_count{cnt}.tsv"
    shell:
        """
        for input in {input.snf} {input.snf_germline}; do
            if [[ $input =~ "chm13" ]]; then
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/chm13.reg.bed -c {wildcards.cnt} -C -I $input >> {output.snf} 
            else
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/hg38.reg.bed -c {wildcards.cnt} -C -I $input >> {output.snf} 
            fi
        done
        """


rule gafcall_eval_length_snf_normal:
    input:
        snf = "../1b.alignment_sv_tools_normal/output/sniffles_mosaic/{cell_line_label2}/{assembly}.vcf.gz",
        snf_germline = "../1b.alignment_sv_tools_normal/output/sniffles/{cell_line_label2}/{assembly}.vcf.gz"
    output:
        snf = "output/gafcall_eval/normal_v2_{assembly}_snf2/{cell_line_label2}_eval_len_count{cnt}.tsv"
    shell:
        """
        for input in {input.snf} {input.snf_germline}; do
            if [[ $input =~ "chm13" ]]; then
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/chm13.reg.bed -c {wildcards.cnt} -C -I $input >> {output.snf} 
            else
                ../gafcall/js/gafcall.js view -b ../4.gafcall_evaluation/hg38.reg.bed -c {wildcards.cnt} -C -I $input >> {output.snf} 
            fi
        done
        """


rule gafcall_eval_length_combine_snf:
    input:
        snf = expand("output/gafcall_eval/normal_v2_{assembly}_snf1/{{cell_line_label1}}_eval_len_count{cnt}.tsv", assembly=['chm13', 'grch38'], cnt=[2,3,4,5]),
    output:
        snf = "output/gafcall_eval/normal_v2_snf1/{cell_line_label1}_merged_eval.len.tsv"
    run:
        cat_minisv_view(input.snf, output.snf)



rule gafcall_eval_length_combine_snf2:
    input:
        snf = expand("output/gafcall_eval/normal_v2_{assembly}_snf2/{{cell_line_label2}}_eval_len_count{cnt}.tsv", assembly=['chm13', 'grch38'], cnt=[2,3,4,5])
    output:
        snf = "output/gafcall_eval/normal_v2_snf2/{cell_line_label2}_merged_eval.len.tsv"
    run:
        cat_minisv_view(input.snf, output.snf)


rule gafcall_eval_length_merge_all_snf:
    input:
        eval_length1 = expand("output/gafcall_eval/normal_v2_snf1/{cell_line_label1}_merged_eval.len.tsv", cell_line_label1=cell_lines_labels1),
        eval_length2 = expand("output/gafcall_eval/normal_v2_snf2/{cell_line_label2}_merged_eval.len.tsv", cell_line_label2=cell_lines_labels2)
    output:
        eval_length = "output/gafcall_eval/normal_v2/snf_all_merged_eval.len.tsv"
    shell:
        "cat {input.eval_length1} {input.eval_length2} >> {output.eval_length}"


rule gafcall_eval_length_combine:
    input:
        eval_length = expand("output/gafcall_eval/normal_v2/{{cell_line}}_{comb}_eval_len_count{cnt}.tsv", comb=['chm13l+x', 'chm13l+g', 'chm13l+gs', 'chm13l+s', 'hg38l+x', 'hg38l+t', 'hg38l+ts', 'hg38l+tg', 'hg38l+tgs'], cnt=[2,3,4,5])
    output:
        eval_length = "output/gafcall_eval/normal_v2/{cell_line}_merged_eval.len.tsv"
    run:
        cat_minisv_view(input.eval_length, output.eval_length)


rule gafcall_eval_length_merge_all:
    input:
        eval_length = expand("output/gafcall_eval/normal_v2/{cell_line}_merged_eval.len.tsv", cell_line=cell_lines),
        eval_length_severus = "output/gafcall_eval/normal_v2/severus_all_merged_eval.len.tsv",
        eval_length_sniffles2 = "output/gafcall_eval/normal_v2/snf_all_merged_eval.len.tsv",
        eval_length_cutesv = "output/gafcall_eval/normal_v2/cutesv_all_merged_eval.len.tsv"
    output:
        eval_length = "output/gafcall_eval/normal_v2/all_merged_eval.len.tsv"
    shell:
        "echo -e 'translocation\t>1M\t>100k\t>20k\tall_except_inv\tinv\tfile\tcount\tcount_file' > {output.eval_length} && cat {input.eval_length} {input.eval_length_severus} {input.eval_length_sniffles2} {input.eval_length_cutesv} >> {output.eval_length}"


# Figure 2 
rule plot_normal:
    input:
        eval_length = "output/gafcall_eval/normal_v2/all_merged_eval.len.tsv"
    params:
        select = 'BL'
    conda: "plot"
    output:
        paired = "output/gafcall_eval/normal_v2/paired_length_hifi.pdf",
        normal = "output/gafcall_eval/normal_v2/normal_length_hifi.pdf",
        hg38paired = "output/gafcall_eval/normal_v2/hg38_paired_length_hifi.pdf",
        chm13paired = "output/gafcall_eval/normal_v2/chm13_paired_length_hifi.pdf",
        hg38normal = "output/gafcall_eval/normal_v2/Figure2_hg38_normal_length_hifi.pdf",
        chm13normal = "output/gafcall_eval/normal_v2/chm13_normal_length_hifi.pdf",

        normal_germline = "output/gafcall_eval/normal_v2/germline_normal_length_hifi.pdf",
        hg38normal_germline = "output/gafcall_eval/normal_v2/Figure2_germline_hg38_normal_length_hifi.pdf",
  
        paired_mosaic_thresholds = "output/gafcall_eval/normal_v2/mosaic_thresholds_hg38_normal_length_hifi.pdf",
        normal_mosaic_thresholds = "output/gafcall_eval/normal_v2/normal_thresholds_hg38_normal_length_hifi.pdf"
    script:
        "scripts/plot_sv_num_per_length.R"


# Figure 3
rule colo829_hifi_ont_evaluation:
    input:
        colo829_hifi = expand(os.path.join("../1a.alignment_sv_tools/output/minisv_eval_tnpair", '{cell_line}_hifi1_{assembly}_count{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10], assembly=['chm13', 'grch38']),
        colo829_hifi_mosaic = expand(os.path.join("../10.mixed_assembly/output/minisv_mosaic_asm", '{cell_line}_hifi1_grch38_count{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10]),
        # Ultralong
        # colo829_ont  = expand(os.path.join("../1c.additional_ont/output/minisv_eval_tnpair", '{cell_line}_{assembly}_count{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10], assembly=['chm13', 'grch38'])
        # NOTE: non-ultralong is actually using the gafcall hifi data, look at ../1e.reps_merge/ instead
        # colo829_ont  = expand(os.path.join("../1a.alignment_sv_tools/output/minisv_eval_tnpair", '{cell_line}_ont1_{assembly}_count{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10], assembly=['chm13', 'grch38'])
        # below are real non-ultralong ONT
        colo829_ont  = expand(os.path.join("../1f.severus_colo829_ont/output/minisv_eval_tnpair", '{cell_line}_ont1_{assembly}_cutoff{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10], assembly=['chm13', 'grch38'])
    conda: "plot"
    output:
        table="colo829_hifi_clean.tsv",
        ont_table="colo829_ont_clean.tsv",
        mixed_table="colo829_mixed_clean.tsv",
        #plot="colo829_hifi_clean.png",
        hg38plot="hg38_colo829_hifi_clean.pdf",
        chm13plot="chm13_colo829_hifi_clean.pdf",
        hg38plot_ont="hg38_colo829_ont_clean.pdf",
        chm13plot_ont="chm13_colo829_ont_clean.pdf",
        mixedhg38plot="mixedhg38_colo829_ont_clean.pdf",
        #mixedchm13plot="mixedchm13_colo829_ont_clean.pdf",
        ##f1plot="colo829_hifi_clean_max.png",
    script:
        "scripts/tn_pair_precision_recall.R"


# Figure 3 local eval
rule colo829_hifi_ont_evaluation_local:
    input:
        colo829_hifi = expand(os.path.join("output/minisv_eval_tnpair_from1a", '{cell_line}_hifi1_{assembly}_count{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10], assembly=['chm13', 'grch38']),
        colo829_hifi_mosaic = expand(os.path.join("../10.mixed_assembly/output/minisv_mosaic_asm", '{cell_line}_hifi1_grch38_count{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10]),
        colo829_hifi_mosaic_100kb = expand(os.path.join("../10.mixed_assembly/output/minisv_mosaic_asm", '{cell_line}_hifi1_grch38_count{count}_eval_100kb.tsv'), cell_line=['COLO829'], count=[3,4,5,10]),
        colo829_ont  = expand(os.path.join("../1f.severus_colo829_ont/output/minisv_eval_tnpair", '{cell_line}_ont1_{assembly}_cutoff{count}_eval.tsv'), cell_line=['COLO829'], count=[3,4,5,10], assembly=['chm13', 'grch38'])
    conda: "plot"
    output:
        table="output/local/colo829_hifi_clean.tsv",
        ont_table="output/local/colo829_ont_clean.tsv",
        mixed_table="output/local/colo829_mixed_clean.tsv",
        mixed_table_100kb="output/local/colo829_mixed_clean100kb.tsv",
        hg38plot="output/local/Figure3_hg38_colo829_hifi_clean.pdf",
        chm13plot="output/local/chm13_colo829_hifi_clean.pdf",
        hg38plot_ont="output/local/hg38_colo829_ont_clean.pdf",
        chm13plot_ont="output/local/chm13_colo829_ont_clean.pdf",
        mixedhg38plot="output/local/mixedhg38_colo829_ont_clean.pdf",
        #mixedchm13plot="mixedchm13_colo829_ont_clean.pdf",
        ##f1plot="colo829_hifi_clean_max.png",
    script:
        "scripts/tn_pair_precision_recall.R"


module tnpair_plot_concensus_workflow:
    snakefile: "rules/tnpair_concensus.smk"
    config: config

use rule * from tnpair_plot_concensus_workflow as r_tnpair_plot_concensus_workflow_*


# Figure 5: tumor-only mode
# Now it changes to be Supplementary Figure 
rule noncolo829_hifi_tumor_only_evaluation:
    input:
        tumor_only_hifi = expand("../1a.alignment_sv_tools/output/minisv_eval_singleT/single_{cell_line}_hifi1_{assembly}_count{cutoff}_eval_len100kb.tsv", cell_line=['HCC1395', 'HCC1937', 'HCC1954', 'NCI1437', 'NCI2009'], cutoff=[2,3,4,5], assembly=['chm13', 'grch38'])
    conda: "plot"
    output:
        tumor_only_table="noncolo829_tumor_only_clean.tsv",
        hg38plot="tumor_only_hg38_noncolo829_hifi_clean.pdf",
    script:
        "scripts/tn_pair_precision_recall_noncolo829_tumoronly.R"


minisv_eval_singlemode_files_hifi_100kb = expand(expand("output/minisv_eval_singleT/single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_100kb.tsv", zip, cell_line=config['hifi_samples']['single_sample_mode']['batch1']['cell_line1'], platform=config['hifi_samples']['single_sample_mode']['batch1']['platform1']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10])

minisv_eval_singlemode_files_ont_100kb = expand(expand("output/minisv_eval_singleT/{{folder}}_single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_ont_100kb.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch3']['cell_line3'], platform=config['samples']['tumor_normal_pair']['batch3']['platform3']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch3']['label']) + expand(expand("output/minisv_eval_singleT/{{folder}}_single_{cell_line}_{platform}_{{assembly}}_count{{cutoff}}_eval_ont_100kb.tsv", zip, cell_line=config['samples']['tumor_normal_pair']['batch4']['cell_line4'], platform=config['samples']['tumor_normal_pair']['batch4']['platform4']), assembly=['chm13', 'grch38'], cutoff=[3,4,5,10], folder=config['samples']['tumor_normal_pair']['batch4']['label'])

print(minisv_eval_singlemode_files_hifi_100kb)

# Figure 5: tumor-only mode local evaluation using somatic concensus from severus, savana, nanomonsv or msv, savana, nanomonsv
rule noncolo829_hifi_tumor_only_evaluation_somatic_SV:
    input:
        # f"output/minisv_eval_singleT/{{folder}}_single_{{cell_line}}_{{platform}}_{{assembly}}_count{cutoff}_eval_ont_100kb.tsv"
        tumor_only_hifi = minisv_eval_singlemode_files_hifi_100kb,
        tumor_only_ont_100kb = minisv_eval_singlemode_files_ont_100kb
    conda: "plot"
    output:
        tumor_only_table="output/local/noncolo829_tumor_only_clean.tsv",
        tumor_only_table_ont="output/local/ont_noncolo829_tumor_only_clean.tsv",
        hg38plot="output/local/tumor_only_hg38_noncolo829_hifi_clean.pdf",
    script:
        "scripts/tn_pair_precision_recall_noncolo829_tumoronly_local.R"


module othercaller_count_workflow:
    snakefile: "rules/othercaller_count_asm.smk"
    config: config

use rule * from othercaller_count_workflow as r_othercaller_count_workflow_*

module consensus_eval_mosaic_workflow:
    snakefile: "rules/mosaic_singlesample_asm_eval.smk"
    config: config
use rule * from consensus_eval_mosaic_workflow as r_consensus_eval_mosaic_workflow_*

module colo829_barchart_tnpair_workflow:
    snakefile: "rules/tnpair_colo829_asm_eval.smk"
    config: config

use rule * from colo829_barchart_tnpair_workflow as r_colo829_barchart_tnpair_workflow_*

rule all: 
    input:
        minisv_eval_tnpair_files_hifi,
        minisv_eval_tnpair_concensus_files_hifi,
        minisv_eval_tnpair_concensus_files_ont, minisv_eval_tnpair_concensus_files_ont_tgs,
        minisv_eval_singlemode_files_hifi, minisv_eval_singlemode_files_hifi_100kb,
        minisv_eval_singlemode_files_ont_100kb,

        "output/gafcall_eval/normal_v2/all_merged_eval.len.tsv",
        "output/gafcall_eval/normal_v2/normal_length_hifi.pdf",
        "tumor_only_hg38_noncolo829_hifi_clean.pdf",
        rules.r_tnpair_plot_concensus_workflow_all.input,
        rules.r_othercaller_count_workflow_all.input,
        rules.r_consensus_eval_mosaic_workflow_all.input,
        rules.r_colo829_barchart_tnpair_workflow_all.input,

        "hg38_colo829_hifi_clean.pdf", 
        "output/local/Figure3_hg38_colo829_hifi_clean.pdf",
        "output/local/tumor_only_hg38_noncolo829_hifi_clean.pdf",

        "output/gafcall_eval/normal_v2/hg38_paired_length_hifi.pdf",
        "output/gafcall_eval/normal_v2/chm13_paired_length_hifi.pdf",
        "output/gafcall_eval/normal_v2/paired_length_hifi.pdf",
        "output/gafcall_eval/normal_v2/Figure2_hg38_normal_length_hifi.pdf",
        "output/gafcall_eval/normal_v2/germline_normal_length_hifi.pdf", "output/gafcall_eval/normal_v2/Figure2_germline_hg38_normal_length_hifi.pdf", "output/gafcall_eval/normal_v2/mosaic_thresholds_hg38_normal_length_hifi.pdf", "output/gafcall_eval/normal_v2/normal_thresholds_hg38_normal_length_hifi.pdf",
        "output/gafcall_eval/normal_v2/severus_all_merged_eval.len.tsv",
        "output/gafcall_eval/normal_v2/snf_all_merged_eval.len.tsv",
        "output/gafcall_eval/normal_v2/cutesv_all_merged_eval.len.tsv",
        expand("output/minisv_phase/{cell_line}_grch38_phased_tg.msv", cell_line = cell_lines_sub),
        expand("output/minisv_phase/{cell_line}_grch38_phased_tg_filtered.msv", cell_line = cell_lines_sub)
    default_target: True
